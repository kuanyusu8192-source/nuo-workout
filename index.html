<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NUOå¥èº« Pro (Debug)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#2c3e50">
    <style>
        /* CSS æ¨£å¼å€ */
        :root {
            --primary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --grey: #95a5a6;
            --card-bg: #ffffff;
            --travel-color: #9b59b6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: var(--dark);
            margin: 0;
            padding: 0;
            padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* é ‚éƒ¨å„€è¡¨æ¿ */
        .dashboard {
            background: var(--dark);
            color: white;
            padding: 20px 15px;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: background 0.3s;
        }
        .dashboard.travel-mode { background: var(--travel-color); }

        .mode-switch-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .app-title { font-size: 1.2rem; font-weight: bold; }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.3);
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(26px); }
        .switch-label { font-size: 0.8rem; margin-left: 10px; color: rgba(255,255,255,0.9); }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .total-vol { font-size: 1.8rem; font-weight: bold; color: var(--success); }
        .dashboard.travel-mode .total-vol { color: #f1c40f; }
        .total-label { font-size: 0.8rem; opacity: 0.8; }

        /* ç¿’æ…£éˆ */
        .habit-tracker {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-top: 10px;
        }
        .habit-day {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.5);
        }
        .habit-day.active {
            background: var(--success);
            color: white;
            font-weight: bold;
            box-shadow: 0 0 5px var(--success);
        }
        .dashboard.travel-mode .habit-day.active {
            background: #f1c40f;
            color: var(--dark);
            box-shadow: 0 0 5px #f1c40f;
        }
        .habit-day.today { border: 1px solid white; }

        .btn-history {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        /* æ˜ŸæœŸé¸æ“‡å™¨ */
        .day-selector {
            display: flex;
            overflow-x: auto;
            padding: 15px;
            gap: 10px;
            scrollbar-width: none;
        }
        .day-btn {
            background: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            color: var(--grey);
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .day-btn.active {
            background: var(--dark);
            color: white;
            box-shadow: 0 4px 8px rgba(44, 62, 80, 0.3);
        }
        .travel-mode-body .day-btn.active { background: var(--travel-color); }

        /* è¨“ç·´å¡ç‰‡ */
        .container { padding: 0 15px; }
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            border-left: 5px solid var(--dark);
        }
        .travel-mode-body .card { border-left-color: var(--travel-color); }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .exercise-name { font-size: 1.1rem; font-weight: bold; }
        .one-rm { font-size: 0.75rem; color: var(--warning); font-weight: bold; background: #fff8e1; padding: 2px 6px; border-radius: 4px; }
        .desc-text { font-size: 0.85rem; color: #666; margin-bottom: 12px; line-height: 1.4; }

        .log-area {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }
        .input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1.1rem;
            text-align: center;
            background: white;
            -moz-appearance: textfield;
        }
        .btn-log {
            background: var(--dark);
            color: white;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            margin-top: 5px;
        }
        .travel-mode-body .btn-log { background: var(--travel-color); }
        .history-text {
            font-size: 0.75rem;
            color: var(--grey);
            margin-bottom: 5px;
            text-align: right;
        }

        /* æµ®å‹•è¨ˆæ™‚å™¨ */
        .timer-float {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: var(--dark);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 150;
            cursor: pointer;
            border: 2px solid var(--success);
            font-size: 0.9rem;
        }

        .cooldown-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(243, 156, 18, 0.4);
            z-index: 100;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* æ—¥æ›† */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px; }
        .cal-day-header { font-size: 0.8rem; color: var(--grey); font-weight: bold; padding-bottom: 5px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.9rem; cursor: pointer; position: relative; }
        .cal-day:hover { background-color: #f0f0f0; }
        .cal-day.has-data { background-color: #d5f5e3; color: var(--success); font-weight: bold; }
        .cal-day.has-data::after { content: ''; position: absolute; bottom: 3px; width: 4px; height: 4px; background: var(--success); border-radius: 50%; }
        .history-details { text-align: left; border-top: 1px solid #eee; padding-top: 15px; }
        .history-item { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #f9f9f9; }

        .timer-display { font-size: 4rem; font-weight: bold; color: var(--dark); font-variant-numeric: tabular-nums; }
        .timer-controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-timer { padding: 10px 20px; border-radius: 8px; border: none; font-size: 1rem; font-weight: bold; }
        .btn-stop { background: var(--danger); color: white; }
        .btn-add { background: var(--light); color: var(--dark); }
        .close-btn-corner { float: right; font-size: 1.5rem; cursor: pointer; color: #999; }
    </style>
</head>
<body id="bodyTag">

<!-- å„€è¡¨æ¿å€åŸŸ -->
<div class="dashboard" id="dashboard">
    <div class="mode-switch-container">
        <div class="app-title" id="appTitle">NUOå¥èº« Pro</div>
        <div style="display:flex; align-items:center;">
            <label class="switch">
                <input type="checkbox" id="modeToggle" onchange="toggleMode()">
                <span class="slider"></span>
            </label>
            <span class="switch-label" id="modeLabel">å™¨æ</span>
        </div>
    </div>

    <div class="stats-row">
        <div>
            <div class="total-label">ä»Šæ—¥è¨“ç·´é‡ (Volume)</div>
            <div class="total-vol" id="todayVolume">0 <span style="font-size:1rem;">kg</span></div>
        </div>
        <div style="text-align:right;">
            <div class="total-label">é€£çºŒç´€éŒ„</div>
            <div style="color:white; font-weight:bold;" id="streakCount">ğŸ”¥ 0 å¤©</div>
        </div>
    </div>
    
    <div class="total-label" style="margin-bottom:5px;">ç¿’æ…£éˆ (éå»4é€±)</div>
    <div class="habit-tracker" id="habitGrid"></div>
    <button class="btn-history" onclick="openHistoryModal()">ğŸ“… æŸ¥çœ‹å®Œæ•´æ­·å²ç´€éŒ„</button>
</div>

<!-- æ˜ŸæœŸå°èˆª -->
<div class="day-selector" id="daySelector"></div>

<!-- è¨“ç·´åˆ—è¡¨ -->
<div class="container" id="workoutContainer"></div>

<!-- æ‡¸æµ®è¨ˆæ™‚å™¨ -->
<div id="floatTimer" class="timer-float" onclick="openTimerModal()">00:00</div>

<!-- åº•éƒ¨æ”¶æ“ -->
<button class="cooldown-btn" onclick="openCooldown()">ğŸ§˜ è¨“ç·´çµæŸ & æ”¶æ“</button>

<!-- è¦–çª— 1: è¨ˆæ™‚å™¨ -->
<div id="timerModal" class="modal">
    <div class="modal-content">
        <h3 style="margin:0; color:#888;">çµ„é–“ä¼‘æ¯</h3>
        <div class="timer-display" id="timerBigDisplay">01:30</div>
        <div class="timer-controls">
            <button class="btn-timer btn-add" onclick="adjustTimer(-10)">-10s</button>
            <button class="btn-timer btn-add" onclick="adjustTimer(10)">+10s</button>
        </div>
        <div class="timer-controls">
            <button class="btn-timer btn-stop" onclick="closeTimerModal(true)">åœæ­¢è¨ˆæ™‚</button>
            <button class="btn-timer" style="background:var(--primary); color:white;" onclick="closeTimerModal(false)">èƒŒæ™¯åŸ·è¡Œ</button>
        </div>
    </div>
</div>

<!-- è¦–çª— 2: æ”¶æ“ -->
<div id="cooldownModal" class="modal" onclick="if(event.target === this) closeCooldown()">
    <div class="modal-content" style="text-align:left;">
        <h2 style="margin-top:0;">ä»Šæ—¥æ”¶æ“å»ºè­°</h2>
        <div id="cooldownText" style="line-height:1.6; color:#444;"></div>
        <button class="btn-log" style="margin-top:20px;" onclick="closeCooldown()">å®Œæˆ</button>
    </div>
</div>

<!-- è¦–çª— 3: æ­·å²ç´€éŒ„ -->
<div id="historyModal" class="modal" onclick="if(event.target === this) closeHistoryModal()">
    <div class="modal-content" style="padding:15px;">
        <span class="close-btn-corner" onclick="closeHistoryModal()">&times;</span>
        <div class="calendar-header">
            <button class="btn-timer btn-add" style="padding:5px 10px;" onclick="changeMonth(-1)">â®</button>
            <h3 id="calTitle" style="margin:0;">2023 å¹´ 10 æœˆ</h3>
            <button class="btn-timer btn-add" style="padding:5px 10px;" onclick="changeMonth(1)">â¯</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        <div class="history-details" id="historyDetails">
            <p style="color:#999; text-align:center;">é»é¸æ—¥æœŸæŸ¥çœ‹è©³ç´°ç´€éŒ„</p>
        </div>
    </div>
</div>

<script>
    // --- å…¨åŸŸéŒ¯èª¤æ””æˆª (é™¤éŒ¯ç”¨) ---
    window.onerror = function(msg, url, line) {
        alert("ç¨‹å¼ç™¼ç”Ÿåš´é‡éŒ¯èª¤:\n" + msg + "\nè¡Œæ•¸: " + line + "\nè«‹æˆªåœ–çµ¦é–‹ç™¼è€…");
        return false;
    };

    // --- è³‡æ–™åº« ---
    const gymWorkouts = {
        0: { name: "é€±æ—¥", focus: "ä¼‘æ¯æ—¥", exercises: [], cooldown: "æ”¾é¬†å¿ƒæƒ…ï¼Œæº–å‚™è¿æ¥æ–°çš„ä¸€é€±ã€‚" },
        1: { name: "é€±ä¸€", focus: "æ¨ (èƒ¸/è‚©/ä¸‰é ­)", 
            exercises: [
                {id: "m1", name: "å•éˆ´è‡¥æ¨", muscle: "èƒ¸å¤§è‚Œ", desc: "èƒŒè²¼ç·Šï¼Œç©©å®šçš„æ¨èˆ‰ã€‚"},
                {id: "m2", name: "ä¸Šæ–œå•éˆ´è‡¥æ¨", muscle: "ä¸Šèƒ¸", desc: "æ¤…èƒŒ30åº¦ï¼Œå°ˆæ³¨ä¸Šèƒ¸ã€‚"},
                {id: "m3", name: "åå§¿å•éˆ´è‚©æ¨", muscle: "å‰ä¸‰è§’", desc: "æ ¸å¿ƒæ”¶ç·Šï¼Œä¸éåº¦æŒºè…°ã€‚"},
                {id: "m4", name: "å•éˆ´å´å¹³èˆ‰", muscle: "ä¸­ä¸‰è§’", desc: "æ‰‹è‚˜å¾®å½ï¼Œä¸è¦è³è‚©ã€‚"},
                {id: "m5", name: "éé ‚ä¸‰é ­å±ˆä¼¸", muscle: "ä¸‰é ­è‚Œ", desc: "å¤§è‡‚å¤¾ç·Šé ­éƒ¨å…©å´ã€‚"}
            ], cooldown: "1. èƒ¸è‚Œæ‹‰ä¼¸ 30s<br>2. è‚©å‰å´æ‹‰ä¼¸ 30s<br>3. ä¸‰é ­è‚Œæ‹‰ä¼¸ 30s" },
        2: { name: "é€±äºŒ", focus: "æ‹‰ (èƒŒ/å¾Œè‚©/äºŒé ­)", 
            exercises: [
                {id: "t1", name: "å–®è‡‚åˆ’èˆ¹", muscle: "èƒŒé—Šè‚Œ", desc: "åƒæ‹‰é‹¸å­ä¸€æ¨£ï¼Œå°‡æ‰‹è‚˜æ‹‰éèƒŒéƒ¨ã€‚"},
                {id: "t2", name: "é›™æ‰‹åˆ’èˆ¹", muscle: "ä¸ŠèƒŒ", desc: "ä¿¯èº«ï¼Œè„Šæ¤ä¿æŒä¸­ç«‹ã€‚"},
                {id: "t3", name: "åå‘é£›é³¥", muscle: "å¾Œä¸‰è§’", desc: "å°ˆæ³¨å¾Œè‚©ç™¼åŠ›ï¼Œä¸è¦å¤¾è‚©èƒ›ã€‚"},
                {id: "t4", name: "ç«™å§¿å½èˆ‰", muscle: "äºŒé ­è‚Œ", desc: "èº«é«”ä¸æ™ƒå‹•ï¼Œé›¢å¿ƒæ…¢æ”¾ã€‚"},
                {id: "t5", name: "å‚å¼å½èˆ‰", muscle: "è‚±è‚Œ", desc: "æŒå¿ƒç›¸å°ï¼ŒåŒæ™‚è¨“ç·´å‰è‡‚ã€‚"}
            ], cooldown: "1. å¬°å…’å¼ 60s<br>2. èƒŒéƒ¨å´æ‹‰ä¼¸ 30s<br>3. äºŒé ­è‚Œæ‹‰ä¼¸ 30s" },
        3: { name: "é€±ä¸‰", focus: "è…¿ (è‚¡å››/å¾Œè…¿)", 
            exercises: [
                {id: "w1", name: "é«˜è…³æ¯æ·±è¹²", muscle: "è‚¡å››é ­", desc: "æŒå•éˆ´æ–¼èƒ¸å‰ï¼Œè¹²æ·±ã€‚"},
                {id: "w2", name: "å•éˆ´åˆ†è…¿è¹²", muscle: "å–®è…¿/è‡€", desc: "ä¿æŒå¹³è¡¡ï¼Œè†è“‹å°æº–è…³å°–ã€‚"},
                {id: "w3", name: "RDL ç¡¬èˆ‰", muscle: "è…¿å¾Œ/è‡€", desc: "å±è‚¡å¾Œæ¨ï¼Œæ„Ÿå—è…¿å¾Œæ‹‰æ‰¯ã€‚"},
                {id: "w4", name: "åå§¿æè¸µ", muscle: "å°è…¿", desc: "å•éˆ´æ”¾è†ä¸Šï¼Œå¢Šè…³å°–ã€‚"}
            ], cooldown: "1. è‚¡å››é ­è‚Œæ‹‰ä¼¸ 30s<br>2. åå§¿é«”å‰å½ 30s<br>3. é´¿å¼ä¼¸å±• 30s" },
        4: { name: "é€±å››", focus: "ä¸»å‹•æ¢å¾©", exercises: [], cooldown: "åšé»ç‘œçˆæˆ–æ»¾ç­’æ”¾é¬†ã€‚" },
        5: { name: "é€±äº”", focus: "ä¸Šè‚¢ç¶œåˆ", 
            exercises: [
                {id: "f1", name: "å¹³åœ°é£›é³¥", muscle: "èƒ¸", desc: "åƒæŠ±å¤§æ¨¹ä¸€æ¨£æ‰“é–‹é›™æ‰‹ã€‚"},
                {id: "f2", name: "é˜¿è«¾è‚©æ¨", muscle: "è‚©æ•´é«”", desc: "æ—‹è½‰æ¨èˆ‰ï¼Œå¢åŠ è¡Œç¨‹ã€‚"},
                {id: "f3", name: "é›†ä¸­å½èˆ‰", muscle: "äºŒé ­", desc: "å­¤ç«‹äºŒé ­è‚Œå³°ã€‚"},
                {id: "f4", name: "æ¿å‡³æ’é«”", muscle: "ä¸‰é ­", desc: "èº«é«”å‚ç›´ä¸Šä¸‹ã€‚"}
            ], cooldown: "1. ä¸ŠåŠèº«å‹•æ…‹ä¼¸å±•<br>2. é ¸éƒ¨æ”¾é¬†" },
        6: { name: "é€±å…­", focus: "ä¸‹è‚¢/æ ¸å¿ƒ", 
            exercises: [
                {id: "s1", name: "ç›¸æ’²æ·±è¹²", muscle: "å…§æ”¶è‚Œ", desc: "å¯¬ç«™è·ï¼Œè…³å°–å¤–é–‹ã€‚"},
                {id: "s2", name: "å–®è…¿ç¡¬èˆ‰", muscle: "å¹³è¡¡", desc: "æ ¸å¿ƒæ”¶ç·Šï¼Œå–®è…³æ”¯æ’ã€‚"},
                {id: "s3", name: "ä¿„ç¾…æ–¯è½‰é«”", muscle: "è…¹æ–œè‚Œ", desc: "è½‰é«”æ™‚åæ°£ã€‚"},
                {id: "s4", name: "è² é‡æ²è…¹", muscle: "è…¹ç›´è‚Œ", desc: "æ„Ÿå—è…¹è‚Œæ”¶ç¸®ã€‚"}
            ], cooldown: "1. è…¿éƒ¨å…¨å¥—ä¼¸å±•<br>2. è…¹éƒ¨ä¼¸å±• (çœ¼é¡è›‡å¼)" }
    };

    const travelWorkouts = {
        0: { name: "é€±æ—¥", focus: "ä¼‘æ¯æ—¥", exercises: [], cooldown: "å¥½å¥½è£œçœ ï¼Œèª¿æ•´æ™‚å·®æˆ–ç–²å‹ã€‚" },
        1: { name: "é€±ä¸€", focus: "æ¨ (å‡ºå·®ç‰ˆ)", 
            exercises: [
                {id: "tm1", name: "æ¨™æº–ä¼åœ°æŒºèº«", muscle: "èƒ¸/ä¸‰é ­", desc: "èº«é«”å‘ˆä¸€ç›´ç·šï¼Œèƒ¸å£è²¼åœ°å†æ¨èµ·ã€‚"},
                {id: "tm2", name: "å¯¬è·ä¼åœ°æŒºèº«", muscle: "å¤–èƒ¸", desc: "æ‰‹æŒå¯¬æ–¼è‚©è†€ï¼Œæ¸›å°‘ä¸‰é ­è‚Œåƒèˆ‡ã€‚"},
                {id: "tm3", name: "æŠ˜åˆ€ä¼åœ°æŒºèº«", muscle: "è‚©è†€", desc: "å±è‚¡æŠ¬é«˜å‘ˆå€’Vå­—ï¼Œé ­é ‚æœåœ°æ¿ä¸‹æ”¾ã€‚"},
                {id: "tm4", name: "æ¤…å­/åºŠç·£ æ’é«”", muscle: "ä¸‰é ­è‚Œ", desc: "èƒŒå°æ¤…å­ï¼Œæ‰‹æ’é‚Šç·£ï¼Œèº«é«”ä¸‹æ²‰ã€‚"},
                {id: "tm5", name: "å‹•æ…‹æ£’å¼", muscle: "æ ¸å¿ƒ/è‚©", desc: "ç”±æ‰‹è‚˜æ’åœ°è½‰ç‚ºæ‰‹æŒæ’åœ°ï¼Œäº¤äº’é€²è¡Œã€‚"}
            ], cooldown: "1. æ‰¾ç‰†å£æ‹‰ä¼¸èƒ¸å¤§è‚Œ 30s<br>2. ä¸‰é ­è‚Œä¼¸å±• 30s" },
        2: { name: "é€±äºŒ", focus: "æ‹‰ (å‡ºå·®ç‰ˆ)", 
            exercises: [
                {id: "tt1", name: "é–€æ¡†åˆ’èˆ¹", muscle: "èƒŒéƒ¨", desc: "æŠ“è‘—é–€æ¡†é‚Šç·£ï¼Œèº«é«”å¾Œå‚¾ï¼Œç”¨èƒŒåŠ›æŠŠè‡ªå·±æ‹‰å‘é–€æ¡†ã€‚"},
                {id: "tt2", name: "ä¿¯è‡¥ W å­—ä¼¸å±•", muscle: "å¾Œè‚©/ä¸ŠèƒŒ", desc: "è¶´åœ¨åœ°ä¸Šï¼Œæ‰‹è‚˜å½æ›²å‘ˆWå­—ï¼Œå°‡æ‰‹è‡‚æŠ¬é›¢åœ°é¢ã€‚"},
                {id: "tt3", name: "è¶…äººå¼", muscle: "ä¸‹èƒŒ", desc: "è¶´å§¿ï¼ŒåŒæ™‚æŠ¬èµ·æ‰‹è·Ÿè…³ï¼Œåœç•™2ç§’ã€‚"},
                {id: "tt4", name: "æ¯›å·¾äºŒé ­å°æŠ—", muscle: "äºŒé ­è‚Œ", desc: "è…³è¸©æ¯›å·¾ä¸­æ®µï¼Œé›™æ‰‹æŠ“å…©ç«¯ç”¨åŠ›å‘ä¸Šæ‹‰ï¼Œè…¿éƒ¨çµ¦äºˆé˜»åŠ›ã€‚"},
                {id: "tt5", name: "é³¥ç‹—å¼", muscle: "æ ¸å¿ƒ/èƒŒ", desc: "å››è¶³è·ªå§¿ï¼Œå°å´æ‰‹è…³å»¶ä¼¸ã€‚"}
            ], cooldown: "1. å¬°å…’å¼æ”¾é¬†èƒŒéƒ¨<br>2. é ¸éƒ¨å´æ‹‰ä¼¸" },
        3: { name: "é€±ä¸‰", focus: "è…¿ (å‡ºå·®ç‰ˆ)", 
            exercises: [
                {id: "tw1", name: "å¾’æ‰‹æ·±è¹²", muscle: "è‚¡å››é ­", desc: "æ¬¡æ•¸è¦å¤šï¼Œé€Ÿåº¦æ”¾æ…¢ã€‚"},
                {id: "tw2", name: "å¾Œè·¨å¼“æ­¥è¹²", muscle: "å–®è…¿/è‡€", desc: "äº¤æ›¿å‘å¾Œè·¨æ­¥ä¸‹è¹²ï¼Œè†è“‹ä¸è§¸åœ°ã€‚"},
                {id: "tw3", name: "å–®è…³è‡€æ©‹", muscle: "è…¿å¾Œ/è‡€", desc: "èººå§¿ï¼Œå–®è…³è¸©åœ°å°‡å±è‚¡æ¨é«˜ã€‚"},
                {id: "tw4", name: "ä¿åŠ åˆ©äºåˆ†è…¿è¹²", muscle: "è‚¡å››é ­/è‡€", desc: "å¾Œè…³èƒŒæ”¾åœ¨åºŠæ²¿æˆ–æ¤…å­ä¸Šï¼Œå‰è…³ä¸‹è¹²ã€‚"},
                {id: "tw5", name: "å°è…¿æè¸µ", muscle: "å°è…¿", desc: "å–®è…³ç«™ç«‹ï¼Œæ‰‹æ‰¶ç‰†ï¼Œè…³è·ŸæŠ¬èµ·ã€‚"}
            ], cooldown: "1. è‚¡å››é ­è‚Œç«™å§¿æ‹‰ä¼¸<br>2. åå§¿é«”å‰å½" },
        4: { name: "é€±å››", focus: "ä¼‘æ¯/ä¼¸å±•", exercises: [], cooldown: "åš10åˆ†é˜å…¨èº«ä¼¸å±•æ“ã€‚" },
        5: { name: "é€±äº”", focus: "ä¸Šè‚¢è€åŠ›", 
            exercises: [
                {id: "tf1", name: "é‘½çŸ³ä¼åœ°æŒºèº«", muscle: "ä¸‰é ­/å…§èƒ¸", desc: "é›™æ‰‹é£ŸæŒ‡æ‹‡æŒ‡é åœ¨ä¸€èµ·å‘ˆé‘½çŸ³ç‹€ã€‚"},
                {id: "tf2", name: "Tå­—ä¼åœ°æŒºèº«", muscle: "æ ¸å¿ƒ/èƒ¸", desc: "æ¨èµ·å¾Œèº«é«”è½‰å‘å´é¢ï¼Œå–®æ‰‹æŒ‡å‘å¤©èŠ±æ¿ã€‚"},
                {id: "tf3", name: "ä¿¯è‡¥ Y-T-I æŠ¬æ‰‹", muscle: "è‚©èƒŒ", desc: "è¶´å§¿ï¼Œæ‰‹åˆ†åˆ¥æ“ºå‡ºYã€Tã€Iå­—å‹æŠ¬èµ·ã€‚"},
                {id: "tf4", name: "æ¯›å·¾å´å¹³èˆ‰å°æŠ—", muscle: "ä¸­ä¸‰è§’", desc: "åˆ©ç”¨é–€æŠŠæˆ–æ¯›å·¾åšå´å‘ç­‰é•·æ”¶ç¸®ã€‚"}
            ], cooldown: "ä¸ŠåŠèº«ç¶œåˆä¼¸å±•" },
        6: { name: "é€±å…­", focus: "é«˜å¼·åº¦/ç‡ƒè„‚", 
            exercises: [
                {id: "ts1", name: "æ³¢æ¯”è·³", muscle: "å…¨èº«", desc: "æ·±è¹²->ä¼åœ°æŒºèº«->è·³èµ·ï¼Œé€£çºŒå‹•ä½œã€‚"},
                {id: "ts2", name: "æ·±è¹²è·³", muscle: "è…¿/çˆ†ç™¼åŠ›", desc: "æ·±è¹²åˆ°åº•å¾Œç”¨åŠ›è·³èµ·ã€‚"},
                {id: "ts3", name: "ç™»å±±è€…", muscle: "æ ¸å¿ƒ", desc: "ä¼åœ°æŒºèº«å§¿å‹¢ï¼Œè†è“‹å¿«é€Ÿäº¤æ›¿æå‘èƒ¸å£ã€‚"},
                {id: "ts4", name: "è‡ªè¡Œè»Šæ²è…¹", muscle: "è…¹è‚Œ", desc: "èººå§¿ï¼Œæ‰‹è‚˜è§¸ç¢°å°å´è†è“‹ã€‚"}
            ], cooldown: "è…¿éƒ¨èˆ‡è…¹éƒ¨ä¼¸å±•" }
    };

    let currentDay = new Date().getDay();
    let isTravelMode = false;
    let timerInterval = null;
    let viewDate = new Date();
    const TODAY_KEY = new Date().toISOString().split('T')[0];

    // --- åˆå§‹åŒ–é‚è¼¯ (å«é˜²å‘†) ---
    function init() {
        try {
            // è®€å–æ¨¡å¼
            const savedMode = localStorage.getItem('nuo_mode');
            if (savedMode === 'travel') {
                isTravelMode = true;
                const toggle = document.getElementById('modeToggle');
                if(toggle) toggle.checked = true;
                
                const label = document.getElementById('modeLabel');
                if(label) label.innerText = "å‡ºå·®";

                document.getElementById('appTitle').innerText = "å‡ºå·®è¨“ç·´";
                document.getElementById('dashboard').classList.add('travel-mode');
                document.getElementById('bodyTag').classList.add('travel-mode-body');
            }

            renderDaySelector();
            renderHabitGrid();
            
            // è¼‰å…¥ç•¶æ—¥èª²è¡¨
            loadWorkout(currentDay);
            updateDashboard();
            
            // æ¢å¾©è¨ˆæ™‚å™¨
            if(localStorage.getItem('nuo_timer_end')) {
                const end = parseInt(localStorage.getItem('nuo_timer_end'));
                const now = Date.now();
                if(end > now) startTimer((end - now)/1000);
            }
        } catch(e) {
            alert("åˆå§‹åŒ–å¤±æ•—: " + e.message);
        }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ ---
    window.toggleMode = () => {
        isTravelMode = !isTravelMode;
        
        const dashboard = document.getElementById('dashboard');
        const bodyTag = document.getElementById('bodyTag');
        const label = document.getElementById('modeLabel');
        const title = document.getElementById('appTitle');

        if (isTravelMode) {
            dashboard.classList.add('travel-mode');
            bodyTag.classList.add('travel-mode-body');
            label.innerText = "å‡ºå·®";
            title.innerText = "å‡ºå·®è¨“ç·´";
            localStorage.setItem('nuo_mode', 'travel');
        } else {
            dashboard.classList.remove('travel-mode');
            bodyTag.classList.remove('travel-mode-body');
            label.innerText = "å™¨æ";
            title.innerText = "NUOå¥èº« Pro";
            localStorage.setItem('nuo_mode', 'gym');
        }
        loadWorkout(currentDay);
    }

    function getHistory() {
        return JSON.parse(localStorage.getItem('nuo_global_history')) || {};
    }

    function updateDashboard() {
        try {
            const history = getHistory();
            const todayData = history[TODAY_KEY] || { volume: 0, exercises: [] };
            document.getElementById('todayVolume').innerHTML = `${todayData.volume} <span style="font-size:1rem;">kg</span>`;
            
            let streak = 0;
            let d = new Date();
            // é˜²æ­¢ç„¡çª®è¿´åœˆçš„ç°¡å–®é˜²è­·
            for(let i=0; i<365; i++) {
                let key = d.toISOString().split('T')[0];
                const data = history[key];
                const hasActivity = data && (data.volume > 0 || (data.exercises && data.exercises.length > 0));

                if (hasActivity) {
                    streak++;
                    d.setDate(d.getDate() - 1);
                } else if (key === TODAY_KEY && !hasActivity) {
                    d.setDate(d.getDate() - 1);
                } else {
                    break;
                }
            }
            document.getElementById('streakCount').innerText = `ğŸ”¥ ${streak} å¤©`;
        } catch(e) {
            console.error(e);
        }
    }

    function renderHabitGrid() {
        const grid = document.getElementById('habitGrid');
        grid.innerHTML = '';
        const history = getHistory();
        
        for (let i = 27; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const key = d.toISOString().split('T')[0];
            const isToday = key === TODAY_KEY;
            
            const dayEl = document.createElement('div');
            dayEl.className = `habit-day ${isToday ? 'today' : ''}`;
            const data = history[key];
            if (data && (data.volume > 0 || (data.exercises && data.exercises.length > 0))) {
                dayEl.classList.add('active');
            }
            dayEl.innerText = d.getDate();
            grid.appendChild(dayEl);
        }
    }

    function renderDaySelector() {
        const selector = document.getElementById('daySelector');
        const days = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
        selector.innerHTML = days.map((d, index) => 
            `<button class="day-btn ${index === currentDay ? 'active' : ''}" onclick="changeDay(${index})">${d}</button>`
        ).join('');
    }

    window.changeDay = (dayIndex) => {
        currentDay = dayIndex;
        renderDaySelector();
        loadWorkout(dayIndex);
    }

    function loadWorkout(dayIndex) {
        try {
            const container = document.getElementById('workoutContainer');
            // ç¢ºä¿è³‡æ–™å­˜åœ¨
            const plan = isTravelMode ? travelWorkouts[dayIndex] : gymWorkouts[dayIndex];
            
            if (!plan) throw new Error("æ‰¾ä¸åˆ°èª²è¡¨è³‡æ–™");

            if (plan.exercises.length === 0) {
                container.innerHTML = `<div class="card" style="text-align:center; padding:30px;">
                    <h3 style="margin:0;">${plan.focus}</h3>
                    <p style="color:#666;">${plan.cooldown}</p>
                </div>`;
                return;
            }

            container.innerHTML = plan.exercises.map(ex => {
                const lastLog = JSON.parse(localStorage.getItem(`nuo_last_${ex.id}`)) || {w: isTravelMode ? 0 : 10, r: 10, s: 3};
                let onerm = 0;
                if(lastLog.w > 0 && lastLog.r > 0) onerm = Math.round(lastLog.w * (1 + lastLog.r/30));
                const placeholder = isTravelMode ? "0æˆ–é«”é‡" : "kg";

                return `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="exercise-name">${ex.name}</div>
                            <div style="font-size:0.8rem; color:var(--grey);">${ex.muscle}</div>
                        </div>
                        ${onerm > 0 ? `<div class="one-rm">1RM ~${onerm}kg</div>` : ''}
                    </div>
                    <div class="desc-text">${ex.desc}</div>
                    <div class="log-area">
                        <div class="history-text">ä¸Šæ¬¡: ${lastLog.w}kg Ã— ${lastLog.r} Ã— ${lastLog.s}</div>
                        <div class="input-row">
                            <input type="number" id="w_${ex.id}" value="${lastLog.w}" placeholder="${placeholder}">
                            <input type="number" id="r_${ex.id}" value="${lastLog.r}" placeholder="æ¬¡">
                            <input type="number" id="s_${ex.id}" value="${lastLog.s}" placeholder="çµ„">
                        </div>
                        <button class="btn-log" onclick="saveLog('${ex.id}', '${ex.name}')">ç´€éŒ„ & ä¼‘æ¯</button>
                    </div>
                </div>`;
            }).join('');
        } catch(e) {
            alert("è¼‰å…¥èª²è¡¨å¤±æ•—: " + e.message);
        }
    }

    window.saveLog = (id, name) => {
        try {
            const wInput = document.getElementById(`w_${id}`).value;
            const w = wInput === "" ? 0 : parseFloat(wInput); 
            const r = parseFloat(document.getElementById(`r_${id}`).value) || 0;
            const s = parseFloat(document.getElementById(`s_${id}`).value) || 0;
            
            if (r === 0 || s === 0) return;

            localStorage.setItem(`nuo_last_${id}`, JSON.stringify({ w, r, s }));

            const history = getHistory();
            if (!history[TODAY_KEY]) {
                history[TODAY_KEY] = { volume: 0, exercises: [] };
            }
            
            const sessionVol = w * r * s;
            history[TODAY_KEY].volume += sessionVol;
            history[TODAY_KEY].exercises.push({
                id: id, name: name, w: w, r: r, s: s,
                time: new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'})
            });

            localStorage.setItem('nuo_global_history', JSON.stringify(history));

            updateDashboard();
            renderHabitGrid();
            loadWorkout(currentDay); 
            startTimer(isTravelMode ? 60 : 90);
            openTimerModal();
        } catch(e) {
            alert("å„²å­˜å¤±æ•—: " + e.message);
        }
    }

    // --- æ­·å²æœˆæ›† ---
    window.openHistoryModal = () => {
        viewDate = new Date(); 
        renderCalendar(viewDate);
        document.getElementById('historyModal').style.display = "flex";
    }
    
    window.closeHistoryModal = () => {
        document.getElementById('historyModal').style.display = "none";
    }

    window.changeMonth = (offset) => {
        viewDate.setMonth(viewDate.getMonth() + offset);
        renderCalendar(viewDate);
    }

    function renderCalendar(date) {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        document.getElementById('calTitle').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = `
            <div class="cal-day-header">æ—¥</div><div class="cal-day-header">ä¸€</div>
            <div class="cal-day-header">äºŒ</div><div class="cal-day-header">ä¸‰</div>
            <div class="cal-day-header">å››</div><div class="cal-day-header">äº”</div>
            <div class="cal-day-header">å…­</div>
        `;

        const history = getHistory();
        
        for(let i=0; i<firstDay.getDay(); i++) {
            grid.innerHTML += `<div></div>`;
        }

        for(let d=1; d<=lastDay.getDate(); d++) {
            const dKey = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const data = history[dKey];
            const hasData = data && (data.volume > 0 || (data.exercises && data.exercises.length > 0));
            
            const div = document.createElement('div');
            div.className = `cal-day ${hasData ? 'has-data' : ''}`;
            div.innerText = d;
            div.onclick = () => showHistoryDetails(dKey, data);
            
            grid.appendChild(div);
        }
        
        document.getElementById('historyDetails').innerHTML = `<p style="color:#999; text-align:center;">é»é¸æ—¥æœŸæŸ¥çœ‹è©³ç´°ç´€éŒ„</p>`;
    }

    function showHistoryDetails(dateStr, data) {
        const detailDiv = document.getElementById('historyDetails');
        document.querySelectorAll('.cal-day').forEach(el => el.classList.remove('selected'));
        
        if (!data || !data.exercises || data.exercises.length === 0) {
            detailDiv.innerHTML = `<h4 style="margin:0 0 10px 0;">${dateStr}</h4><p>ç„¡è¨“ç·´ç´€éŒ„</p>`;
            return;
        }

        let html = `<h4 style="margin:0 0 10px 0;">${dateStr} (ç¸½é‡ ${data.volume}kg)</h4>`;
        [...data.exercises].reverse().forEach(ex => {
            html += `
            <div class="history-item">
                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>${ex.name}</span>
                    <span style="font-size:0.8rem; color:#888;">${ex.time || ''}</span>
                </div>
                <div style="font-size:0.9rem; color:#555;">
                    ${ex.w}kg Ã— ${ex.r}æ¬¡ Ã— ${ex.s}çµ„
                </div>
            </div>`;
        });
        detailDiv.innerHTML = html;
    }

    // --- è¨ˆæ™‚å™¨ ---
    function startTimer(seconds) {
        clearInterval(timerInterval);
        const endTime = Date.now() + seconds * 1000;
        localStorage.setItem('nuo_timer_end', endTime);
        document.getElementById('floatTimer').style.display = 'flex';
        updateTimerDisplay(seconds);
        timerInterval = setInterval(() => {
            const left = Math.ceil((endTime - Date.now())/1000);
            if(left <= 0) {
                clearInterval(timerInterval);
                updateTimerDisplay(0);
                alert("ä¼‘æ¯æ™‚é–“åˆ°ï¼");
                localStorage.removeItem('nuo_timer_end');
                document.getElementById('floatTimer').style.display = 'none';
                closeTimerModal(true);
            } else {
                updateTimerDisplay(left);
            }
        }, 1000);
    }
    
    function updateTimerDisplay(seconds) {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        document.getElementById('floatTimer').innerText = `${m}:${s}`;
        document.getElementById('timerBigDisplay').innerText = `${m}:${s}`;
    }

    window.adjustTimer = (diff) => {
        const currentEnd = parseInt(localStorage.getItem('nuo_timer_end'));
        if(currentEnd) {
            const newEnd = currentEnd + (diff * 1000);
            localStorage.setItem('nuo_timer_end', newEnd);
            const left = Math.ceil((newEnd - Date.now())/1000);
            updateTimerDisplay(left > 0 ? left : 0);
        }
    }

    window.openTimerModal = () => document.getElementById('timerModal').style.display = "flex";
    window.closeTimerModal = (stop) => {
        document.getElementById('timerModal').style.display = "none";
        if(stop) {
            clearInterval(timerInterval);
            document.getElementById('floatTimer').style.display = 'none';
            localStorage.removeItem('nuo_timer_end');
        }
    }

    window.openCooldown = () => {
        const modal = document.getElementById('cooldownModal');
        const text = document.getElementById('cooldownText');
        const plan = isTravelMode ? travelWorkouts[currentDay] : gymWorkouts[currentDay];
        text.innerHTML = plan.cooldown;
        modal.style.display = "flex";
    }
    window.closeCooldown = () => document.getElementById('cooldownModal').style.display = "none";

    // PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').then(() => console.log('SW Registered'));
    }

    // å•Ÿå‹•
    init();
</script>

</body>
</html>
